---
import Layout from "../../layouts/Layout.astro";
import OffreCard from "../../components/OffreCard.astro";
import { getOffres } from "../../js/backend.mjs";
import { filterByPrix } from "../../js/backend.mjs";

let offres = await getOffres();

let message = '';
if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
  const minPrix = Number(data.get("minPrix"));
  const maxPrix = Number(data.get("maxPrix"));

  if (Number.isFinite(minPrix) && Number.isFinite(maxPrix) && minPrix >= 0 && maxPrix > minPrix) {
    offres = await filterByPrix(minPrix, maxPrix);
    if (offres.length === 0) {
            message = `Pas d'offres entre ${minPrix}â‚¬ et ${maxPrix}â‚¬`;
        } else {
            message = `Liste des offres entre ${minPrix}â‚¬ et ${maxPrix}â‚¬`;
        }
    } else {
        message = "Veuillez entrer des valeurs valides pour le prix.";
    }
}
---

<Layout titre="Offres">
  <section class="py-20 px-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-5xl md:text-6xl font-bold text-pink-600 text-center mb-8">
        Offres ðŸŽ€
      </h1>

      {message && (
        <div class="mb-6 p-4 rounded-lg bg-pink-100 text-pink-800 text-center">
          {message}
        </div>
      )}

      <form action="/offres" method="POST" class="mb-6 space-y-4 md:space-y-0 md:flex md:gap-4 md:items-end">
        <div class="flex-1">
          <input 
            type="number" 
            name="minPrix" 
            placeholder="Prix minimum" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
          />
        </div>
        <div class="flex-1">
          <input 
            type="number" 
            name="maxPrix" 
            placeholder="Prix maximum" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
          />
        </div>
        <button 
          type="submit" 
          class="w-full md:w-auto bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300"
        >
          Filtrer par prix
        </button>
      </form>

      <div class="flex gap-4 mb-6">
        <button id="favori-button" class="bg-pink-600 hover:bg-pink-700 rounded-lg text-white py-3 px-6 shadow-md transition duration-300 font-bold">
          Afficher les favoris
        </button>
        <a href="/offres/add" class="bg-pink-600 hover:bg-pink-700 rounded-lg text-white py-3 px-6 shadow-md transition duration-300 font-bold">
          Ajouter une offre
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {
          offres.map((offre) => (
            <div class="offre" data-favori={offre.favori.toString()}>
              <OffreCard offre={offre} />
            </div>
          ))
        }
      </div>
    </div>
  </section>

  <script>
    const button = document.getElementById("favori-button");
    let showOnlyFavorites = false;

    button?.addEventListener("click", () => {
      showOnlyFavorites = !showOnlyFavorites;
      const offres = document.querySelectorAll(".offre");

      offres.forEach((offre) => {
        const htmlElement = offre instanceof HTMLElement ? offre : null;
        if (!htmlElement) return;
        const isFavori = htmlElement.dataset.favori === "true";

        if (showOnlyFavorites) {
          htmlElement.style.display = isFavori ? "block" : "none";
          button.textContent = "Afficher tout";
        } else {
          htmlElement.style.display = "block";
          button.textContent = "Afficher les favoris";
        }
      });
    });
  </script>
</Layout>